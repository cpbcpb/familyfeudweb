{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Game Board</title>
</head>
<body>
<div id="app">
    <div id="board-size">
        {% comment %} <div class="logo-oval"v-show="state.display_logo">
            <div class="logo-text-box" >
                <div>
                    <span class="first-letter" data-text="C">C</span>
                    <span data-text="OUNT">OUNT</span>
                    <span class="y" data-text="y">y</span>
                </div>
                <div>
                    <span class="first-letter" data-text="F">F</span>
                    <span data-text="EUD">EUD</span>
                </div>
            </div>
        </div> {% endcomment %}
        <div class="logo-oval" v-show="state.display_logo"><img src="{% static 'base/logo.png'%}"> </div>
        <div v-if="!state.no_active_games">
            <div id="regular-game" v-if="!state.is_fast_money && !state.display_logo">
                <div class="score">
                    <span v-show="!state.points_awarded">[[state.question_total]]</span>
                     <img style="width: 100%;" v-show="state.points_awarded" src="{% static 'base/logoscreenshot.png' %}" alt="County">
                </div>
                <div id="scores-and-board">
                    <div id="score-left" class="score">
                        [[state.team_1_score]]
                    </div>
                    <div class="game-grid">
                        <div class="game-column">
                        <div class="answer-box" v-if="sortedAnswers[0]"  v-bind:class="{flippy : sortedAnswers[0].currently_displayed}">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div class="number">1</div>
                                </div>
                                <div class="flip-card-back">
                                    <div class="answer-text" v-bind:class="{short : sortedAnswers[0].answer_text.length<11}" >[[sortedAnswers[0].answer_text]]</div>
                                    <div class="answer-points">[[sortedAnswers[0].point_value]]</div>
                                </div>
                            </div>
                        </div>
                        <div v-else  class="answer-box">
                        </div>
                        <div class="answer-box" v-if="sortedAnswers[1]"  v-bind:class="{flippy : sortedAnswers[1].currently_displayed}">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <div class="number">2</div>
                                </div>
                                <div class="flip-card-back">
                                    <div class="answer-text" v-bind:class="{short : sortedAnswers[1].answer_text.length<11}">[[sortedAnswers[1].answer_text]]</div>
                                    <div class="answer-points">[[sortedAnswers[1].point_value]]</div>
                                </div>
                            </div>
                        </div>
                        <div v-else  class="answer-box">
                        </div>
                        <div class="answer-box" v-if="sortedAnswers[2]" v-bind:class="{flippy : sortedAnswers[2].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">3</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[2].answer_text.length<11}">[[sortedAnswers[2].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[2].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                        <div class="answer-box" v-if="sortedAnswers[3]" v-bind:class="{flippy : sortedAnswers[3].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">4</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[3].answer_text.length<11}">[[sortedAnswers[3].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[3].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                        </div>
                        <div class="game-column">
                                    <div class="answer-box" v-if="sortedAnswers[4]" v-bind:class="{flippy : sortedAnswers[4].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">5</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[4].answer_text.length<11}">[[sortedAnswers[4].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[4].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                            <div class="answer-box" v-if="sortedAnswers[5]" v-bind:class="{flippy : sortedAnswers[5].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">6</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[5].answer_text.length<11}">[[sortedAnswers[5].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[5].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                        <div class="answer-box" v-if="sortedAnswers[6]" v-bind:class="{flippy : sortedAnswers[6].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">7</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[6].answer_text.length<11}">[[sortedAnswers[6].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[6].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                        <div class="answer-box" v-if="sortedAnswers[7]" v-bind:class="{flippy : sortedAnswers[7].currently_displayed}">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="number">8</div>
                                    </div>
                                    <div class="flip-card-back">
                                            <div class="answer-text" v-bind:class="{short : sortedAnswers[7].answer_text.length<11}">[[sortedAnswers[7].answer_text]]</div>
                                            <div class="answer-points">[[sortedAnswers[7].point_value]]</div>
                                    </div>
                                </div>
                            </div>
                            <div v-else  class="answer-box">
                            </div>
                        </div>
                        <strikes 
                            v-bind:show_total_wrong="state.show_total_wrong" 
                            v-bind:total_wrong="state.total_wrong" 
                            v-bind:show_single_x="state.show_single_x">
                        </strikes>
                    </div>
                    <div  id="score-right" class="score" v-if="!state.display_logo">
                        [[state.team_2_score]]
                    </div>
                </div>
            </div>
            <div id="fast-money-game" v-if="state.is_fast_money">
                <div class="fast-money-grid" v-if="!state.display_logo">
                    <div class="fm-column">
                        <div class="fm-row" v-for="question in state.fast_money.questions">
                            <div class="fm-box fm-answer-box">
                                <span v-if="question.player_1_answer.display_answer" class="fm-typing">[[question.player_1_answer.answer_text]]</span>
                            </div>
                            <div class="fm-box fm-points-box">
                            <span v-show="question.player_1_answer.display_value">[[question.player_1_answer.point_value]]</span>
                            </div>
                        </div>
                        <div id="total-row" class="fm-row">
                            <div id= "fm-total" class="fm-box">
                            <div> TOTAL</div><div>[[fastMoneyTotal]]</div>
                            </div>
                        </div>
                    </div>
                    <div class="fm-column">
                        <div class="fm-row" v-for="question in state.fast_money.questions">
                            <div class="fm-box fm-answer-box">
                            <span v-if="question.player_2_answer.display_answer" class="fm-typing" >[[question.player_2_answer.answer_text]]</span>
                            </div>
                            <div class="fm-box fm-points-box">
                            <span v-show="question.player_2_answer.display_value">[[question.player_2_answer.point_value]]</span>
                            </div>
                        </div>
                        <div id="total-row" class="fm-row">
                            <div id= "fm-total" >
                        
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    Vue.component('strikes', {
        delimiters:['[[', ']]'],
        data: function(){
            return {
            }
        },
        //In the dom these must be refered to in kebab case number-wrong, show-x, show-one-x.
        props: ['total_wrong', 'show_total_wrong', 'show_single_x'],
        template:
        `
            <div class="strikes row" v-show="show_total_wrong || show_single_x">
                <img v-show="total_wrong>0 || show_single_x" class="col-4" src="{% static 'base/strike.png' %}" alt="strike">
                <img v-show="total_wrong>1 && !show_single_x" class="col-4" src="{% static 'base/strike.png' %}" alt="strike">
                <img v-show="total_wrong>2 && !show_single_x" class="col-4" src="{% static 'base/strike.png' %}" alt="strike">
            </div>
        `
    })
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            displaySocket: new WebSocket(
                'ws://' + window.location.host + '/ws/display_answer/'
            ),
            // Sound that plays with wrong answers.
            buzz: new Audio('{% static 'base/buzz.mp3' %}'),
            //Ding is the sound that plays when an answer is revealed.
            ding: new Audio('{% static 'base/belldesk.mp3' %}'),
            state: {display_logo: true
            },
        },
        methods: {
            receiveMessage: function (e) {
                let data = JSON.parse(e.data);
                this.state = data.state;
                this.showX();
            },
            showX : function () {
                let timeToShowX = 800;
                let xInterval;
                clearTimeout(xInterval);
                if( this.state.show_single_x || 
                (this.state.show_total_wrong == true && this.state.total_wrong>0) ) {
                    this.buzz.play();
                    xInterval = setTimeout(function(){
                    //Stops showing X and stops playing sound.
                        app.buzz.pause();
                        //tells sound to reset to begining of mp3.
                        app.buzz.currentTime = 0;
                        app.state.show_single_x = false;
                        app.state.show_total_wrong = false;
                    }, timeToShowX);
                }
            }
        },
        computed: {
            sortedAnswers: function() {

                //avoids errors during pageload
                if(typeof this.state.current_answers !== "undefined"){

                    //sort answers by point value descending.
                    let arraySorted = this.state.current_answers.sort((a,b) => 
                    (a.point_value > b.point_value) ? -1 : 1 )

                    /*Also add a space around any slash / characters 
                    to avoid unnecessary long words that mess up formatting.*/
                    arraySorted.forEach(function(answer){
                        let answerLetterArray = answer.answer_text.split("");
                        answerLetterArray.forEach(function(letter, index){
                            if(letter =="/"){
                                if(answerLetterArray[index-1]!=" "){
                                    answerLetterArray.splice(index, 0, " ");
                                }
                                if(answerLetterArray[index+1]!=" "){
                                    answerLetterArray.splice(index+1, 0, " ")
                                }
                            }
                        })
                        answer.answer_text = answerLetterArray.join("")
                    })
                    return arraySorted
                }
            },
            sortedFastMoneyQuestions: function(){
                if(this.state.is_fast_money){
                    let arraySorted = this.state.fast_money.questions.sort((a,b) =>
                    (a.order > b.order) ? 1 : -1 );
                    return arraySorted
                }
            },
            fastMoneyTotal : function(){
                if(this.state.is_fast_money){
                    let total = 0;

                    this.state.fast_money.questions.forEach(function(question){
                        if(question.player_1_answer.display_value){
                            total += question.player_1_answer.point_value;
                        }
                        if(question.player_2_answer.display_value){
                            total += question.player_2_answer.point_value;
                        }
                    })
                    return total;
                }
            }
        },
        watch: {
            //Watching sorted answers to see if should reveal a newly displayed answer with flip animation and ding sound
            sortedAnswers: function(newAnswers, oldAnswers){
                //This checks that this isn't the first load of sortedAnswers ever.
                if(typeof oldAnswers !== "undefined"){
                    let interval;
                    clearTimeout(interval);
                    //This plays a ding sound when an answer is revealed (or any other change to 
                    //sortedAnswers but this is the only expected change scenario)
                    for( i = 0; i < newAnswers.length; i++){
                        if(newAnswers[i].currently_displayed===true && oldAnswers[i].currently_displayed===false){
                            this.ding.play();
                            let interval = setTimeout(function(){
                            //stops sound before end of recording.
                            app.ding.pause();
                            //tells sound to reset to begining of mp3.
                            app.ding.currentTime = 0;
                            }, 1040);
                        }
                    }
                }
            }
        }
    })

    app.displaySocket.onmessage = function(e) {
        app.receiveMessage(e);
    }
    app.state = {{state}};

</script>

{% comment %} 

    LOGO:
        TEXT:
            top of text fade orange:       #f26521
            bottom of text fade yello:    #fef041
        BACKGROUND:
            flat middle blue:               #4c6db4


{% endcomment %}
<style>
    #app {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100vw;
        background-image: url('{% static 'base/ConsiderateEuphoricAmurratsnake.gif' %}');
        background-size: cover;
    }


    .logo-oval {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-content: center;
        width: 960px;
        height: 100vh;

    }
    .logo-oval img {
        width: 100%;
        margin-top: 100px;
    }
    {% comment %}  
    .logo-oval {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 560px;
        height: 300px;
        border-radius: 560px / 300px;
        border-style: double;
        border-color: #4c6db4;
        border-width: 20px;
        position: relative;
        background-color: brown;
        z-index: 1;
    }
    .logo-oval:before {
        background-image: radial-gradient(lightblue, dodgerblue),url('{% static 'base/blue_lights_bg.png' %}');
        background-blend-mode: darken;
        background-size: contain;
        border: 4px solid white;
        content: "";
        display: block;
        position: absolute;
        top: 1px;
        left: 1px;
        right: 1px;
        bottom: 1px;
        border-radius: 600px / 300px;
        z-index: -2;
    }

    .logo-text-box {
        position: absolute;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .logo-text-box div span {
        font-size: 100px;
        font-weight: bold;
        -webkit-text-stroke: 2px darkred;
        display: inline-block;
        font-family: Georgia, Times, "Times New Roman", serif;
        background-image: -webkit-linear-gradient(#f26521, #fef041);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position:relative;
        line-height: .75em;
    }
    .logo-text-box div span::after {
        display: inline-block;
        content: attr(data-text);
        left: 0;
        position: absolute;
        text-shadow: 5px 5px 5px black;
        -webkit-text-stroke: 5px white;
        top: 0;
        z-index: -1;
    }
    .first-letter {
        font-size: 150px !important;
        vertical-align: -20px;
    }
    .y {
        font-size: 120px !important;
        vertical-align: 10px;
        line-height: 1.3em !important;
    }
{% endcomment %}

 #board-size {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 1554px;
        height: 821px;
        background-image: url('{% static 'base/background.png' %}');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
 
    } 
    #regular-game {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(50, 115, 220, 0.7);
        height: 100%;
    }

    #scores-and-board {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
    }
    .score {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-content: center;
        align-items: center;
        border-style: solid;
        border-width: 10px;
        border-color: black;
        color: white;
        font-size: 55px;
        font-weight: bold;
        background-image: radial-gradient(darkblue, blue);
        width: 100px;
        height: 100px;
        padding: 8px;
        margin: 10px;
        border-radius: 20px;
    }

    #score-left {
        float: left;
    }
    #score-right {
        float: right;
    }
    .game-grid {
        width: 390px;
        height: 300px;
        display: flex;
        background-color:black;
        flex-direction: row;
        justify-content: space-evenly;
        border-color: orange;
        border-style: solid;
        border-radius: 20px;
        border-width: 5px;
        padding: 10px 10px 10px 10px;
        margin-bottom: 50px;
    }
    .game-column {
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-content: center;
        width: 48%;
    }
    .answer-box {
        background-image: radial-gradient(lightblue, dodgerblue, blue);
        border-style: double;
        border-color: lightgrey;
        border-width: 10px;
        width: 100%;
        height: 50px;
        perspective: 1000px;
    }
    .answer-text {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding-bottom: 3px;
        color: white;
        text-transform: uppercase;
        text-shadow: 2px .5px #000000;
        font-size: 35px;
        background-image: linear-gradient(dodgerblue, blue, darkblue );
        height: 100%;
        width: 85%;
        line-height: .95em;
        overflow:hidden;
    }
    .short {
        font-size:50px;
    }
    .answer-points {
        color: white;
        text-shadow: 2px 1px #000000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        display: flex;
        font-size: 40px;
        text-align: center;
        font-weight: bold;
        width: 15%;
    }
    .number {
        background-color:darkblue;
        color:white;
        border-style: solid;
        border-color: grey;
        border-radius: .7em;
        font-size: 55px;
        font-weight: bold;
        text-align: center;
        vertical-align: top;
        line-height: 1.1em;
        width: 1.5em; 
        height: 1.2em;
    }
    .strikes {
        position: fixed;
        display: flex;
        justify-content: center;
        flex-direction: row;
        align-self: center;
        width: inherit;
    }

    .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    }

    .flippy .flip-card-inner {
        transform: rotateX(180deg);
    }

    .flip-card-front, .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
    }

    .flip-card-front {
        display:flex;
        justify-content: center;
        align-items: center;
    }
    .flip-card-back {
        display: flex;
        flex-direction: row;
        transform: rotateX(180deg);
    }

    .fast-money-grid {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: space-around;
        border-color: black;
        border-style: double;
        border-width: 30px;
        border-radius: 50px;
        padding: 50px 10px 40px 10px;
        background-color:blue;
        width: 840px;
        height: 600px;
    }

    .fm-column {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-content: center;
        align-items: center;
        width: 50%;
    }
    .fm-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-content: center;
        width: 100%;
        height: 15%;
    }
    .fm-box {
        display: flex;
        align-items: center;
        color: white;
        background-color: black;
        margin: 1px;
        font-size : 25px;
        padding: 3px;
        text-transform: uppercase;
    }
    .fm-answer-box {

        width:75%;
        height: 100%;
    }
    .fm-points-box {
        display: flex;
        align-content: center;
        justify-content: center;
        width: 20%;
        height: 100%;

    }
    #fm-total {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        width: 60%;
        padding: 0 10px 0 10px;
    }

    .fm-typing {

  white-space: nowrap;
  overflow: hidden;
  width: 30em;
  animation: type 5s steps(60, end); 
}

@keyframes type{ 
  from { width: 0; } 
} 

</style>
</html>